rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() { return request.auth != null; }
    function memberDoc(orgId) {
      return /databases/$(database)/documents/orgs/$(orgId)/members/$(request.auth.uid);
    }
    function hasMembership(orgId) { return isSignedIn() && exists(memberDoc(orgId)); }
    function role(orgId) { return get(memberDoc(orgId)).data.role; }
    function canManage(orgId) { return hasMembership(orgId) && (role(orgId) in ['admin','manager']); }

    match /users/{uid} {
      allow read, create, update: if isSignedIn() && request.auth.uid == uid;
    }

    match /orgs/{orgId} {
      allow read: if hasMembership(orgId);
      allow write: if canManage(orgId);

      match /members/{uid} {
        allow read: if hasMembership(orgId);
        allow write: if canManage(orgId);
      }

      match /positions/{positionId} {
        allow read: if hasMembership(orgId);
        allow write: if canManage(orgId);
      }

      match /schedules/{scheduleId} {
        allow read: if hasMembership(orgId);
        allow write: if canManage(orgId);

        match /shifts/{shiftId} {
          allow read: if hasMembership(orgId);
          allow write: if canManage(orgId);
        }
      }

      match /availability/{availabilityId} {
        allow read: if hasMembership(orgId);
        allow create: if isSignedIn() && request.auth.uid == request.resource.data.uid && hasMembership(orgId);
        allow update: if isSignedIn() && request.auth.uid == resource.data.uid && hasMembership(orgId);
        allow delete: if canManage(orgId) || (isSignedIn() && request.auth.uid == resource.data.uid);
      }
    }
  }
}
