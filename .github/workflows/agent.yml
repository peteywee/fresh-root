name: Global Cognition Agent

on:
  pull_request:
    types: [opened, synchronize, reopened]
  schedule:
    - cron: "0 2 * * *" # nightly at 02:00 UTC

jobs:
  run-agent:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24.x"
      - name: Ensure PNPM is available
        run: |
          set -e
          if command -v corepack >/dev/null 2>&1; then
            corepack enable || true
            corepack prepare pnpm@9 --activate || true
          fi
          if ! command -v pnpm >/dev/null 2>&1; then
            npm install -g pnpm@9 || true
          fi
          pnpm --version || true
      - name: Install dependencies (no frozen lockfile)
        run: pnpm -w install --no-frozen-lockfile
      - name: Run agent unit tests
        run: node scripts/agent/tests/run-agent-test.mjs

      - name: Regenerate docs/INDEX.md and update PR branch
        if: ${{ github.event_name == 'pull_request' }}
        run: |
          set -e
          ./scripts/index/generate-file-index.sh --write
          # Only commit and push if the index changed
          if ! git diff --quiet -- docs/INDEX.md; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add docs/INDEX.md
            git commit --no-verify -m "ci(agent): regenerate docs/INDEX.md"
            HUSKY_SKIP_HOOKS=1 git push origin HEAD:${{ github.head_ref }}
          else
            echo "docs/INDEX.md unchanged"
          fi

      - name: Run Global Cognition Agent
        continue-on-error: true
        run: node scripts/agent/agent.mjs --pr ${{ github.event.number }} --scope all --format json --scan-rbac --scan-patterns || true
      - name: Upload agent artifact
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: agent-artifact
          path: artifacts/agent-${{ github.event.number }}.json

      - name: Post agent summary comment
        if: ${{ always() && github.event_name == 'pull_request' }}
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const artifact = `artifacts/agent-${{ github.event.number }}.json`;
            if (!fs.existsSync(artifact)) {
              console.log('Agent artifact missing, skipping comment');
              return;
            }
            const content = JSON.parse(fs.readFileSync(artifact, 'utf8'));
            let md = `## Global Cognition Agent Results\n\n`;
            for (const c of content.checks) {
              md += `- **${c.name}**: ${c.result ? 'PASS' : 'FAIL'}\n`;
              if (!c.result) md += `  <details><summary>Output</summary>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\`\`\`\n${c.output}\n\`\`\`\n\n</details>\n`;
            }
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: md,
            });
