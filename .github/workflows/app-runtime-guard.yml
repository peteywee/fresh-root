name: app-runtime-guard

on:
  pull_request:
    branches: [main]

jobs:
  check-allowed-paths:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history for proper diff)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Bypass guard if labeled
        if: contains(join(github.event.pull_request.labels.*.name, ','), 'guard:bypass')
        shell: bash
        run: |
          echo "Guard bypassed via label 'guard:bypass'"

      - name: List changed files
        id: diff
        shell: bash
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          git diff --name-only "$BASE_SHA" "$HEAD_SHA" > changed.txt
          echo "changed<<EOF" >> $GITHUB_OUTPUT
          cat changed.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "Changed files:"
          cat changed.txt || true

      - name: Detect runtime-impacting files (allowlist ONLY)
        if: ${{ !contains(join(github.event.pull_request.labels.*.name, ','), 'guard:bypass') }}
        shell: bash
        run: |
          if [[ ! -f .github/runtime-allowlist.txt ]]; then
            echo "::warning::.github/runtime-allowlist.txt not found, skipping runtime guard."
            exit 0
          fi

          # Load patterns, strip comments/blank lines
          mapfile -t ALLOW < <(sed -e 's/#.*$//' -e '/^\s*$/d' .github/runtime-allowlist.txt)

          if [[ ${#ALLOW[@]} -eq 0 ]]; then
            echo "::warning::runtime-allowlist.txt is empty, skipping runtime guard."
            exit 0
          fi

          ALLOW_RE="$(IFS='|'; echo "${ALLOW[*]}")"
          echo "Runtime allowlist regex: $ALLOW_RE"

          RUNTIME_HIT=0

          while IFS= read -r f; do
            [[ -z "$f" ]] && continue
            # Ignore node_modules noise
            if [[ "$f" =~ (^|/)node_modules(/|$) ]]; then
              continue
            fi

            if echo "$f" | egrep -q "$ALLOW_RE"; then
              echo "âœ“ runtime-impact: $f"
              RUNTIME_HIT=1
            else
              echo "- non-runtime: $f"
            fi
          done < changed.txt

          if [[ $RUNTIME_HIT -eq 0 ]]; then
            echo "No runtime-impacting files changed (according to allowlist)."
          else
            echo "Runtime-impacting changes detected."
          fi

          # IMPORTANT: never fail the job based on files here
          exit 0

      - name: pnpm version (informational)
        shell: bash
        run: |
          corepack enable
          corepack prepare pnpm@9.12.0 --activate
          pnpm -v
