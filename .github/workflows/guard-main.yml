name: Main Branch Guard (Production Gate)

on:
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened ]

jobs:
  main-gate:
    name: Production Quality Gate
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: true

      # 1. Pattern Validation - Tier 0/1 must be zero, score >= 90
      - name: Pattern Validator (90+ production standard)
        env:
          FRESH_PATTERNS_MIN_SCORE: '90'
        run: pnpm lint:patterns
        continue-on-error: false

      # 2. TypeScript Compilation
      - name: TypeScript Compilation Check
        run: pnpm typecheck
        continue-on-error: false

      # 3. ESLint with no blocking errors
      - name: ESLint Code Quality
        run: pnpm lint
        continue-on-error: false

      # 4. Build verification
      - name: Build Verification
        run: pnpm build --filter @apps/web
        continue-on-error: false

      # 5. Block merge if not from develop/dev
      - name: Source Branch Validation
        run: |
          if [[ "${{ github.head_ref }}" != "develop" && "${{ github.head_ref }}" != "dev" ]]; then
            echo "❌ PRs to main must originate from 'dev' or 'develop' branch"
            exit 1
          fi

      # 6. Success comment
      - name: Add Success Comment
        if: success()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `✅ **Production Gate: PASSED**\n\nAll quality checks satisfied:\n- ✅ Patterns (90+ score)\n- ✅ TypeScript (0 errors)\n- ✅ ESLint (0 blocks)\n- ✅ Build (success)\n\nReady for production deployment.`
            })

      # 7. Failure comment with guidance
      - name: Add Failure Comment
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `❌ **Production Gate: FAILED**\n\nOne or more quality checks did not pass. Review the logs above.\n\n**Common issues:**\n- Patterns: \`pnpm lint:patterns:verbose\`\n- Types: \`pnpm typecheck\`\n- Lint: \`pnpm lint --fix\`\n- Build: \`pnpm build --filter @apps/web\`\n\nFix locally, push to \`dev\`, and re-request review.`
            })
