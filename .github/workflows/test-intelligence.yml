name: Test Intelligence Suite

on:
  push:
    branches: [main, develop, claude/**]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  # Quick validation on every push
  quick-check:
    name: Quick Intelligence Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - uses: pnpm/action-setup@v2
        with:
          version: 8

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: |
          cd tests/intelligence
          pnpm install

      - name: Check resources
        run: |
          echo "Memory: $(free -h | awk '/^Mem:/ {print $2}')"
          echo "CPU: $(nproc) cores"

      - name: Run AI Prioritization
        run: cd tests/intelligence && pnpm tsx cli.ts prioritize 20

      - name: Run Security Scan
        run: cd tests/intelligence && pnpm tsx cli.ts security
        continue-on-error: true

      - name: Run Predictive Analytics
        run: cd tests/intelligence && pnpm tsx cli.ts predict 20
        continue-on-error: true

  # Full suite on main/develop
  full-suite:
    name: Full Intelligence Suite
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 10

      - uses: pnpm/action-setup@v2
        with:
          version: 8

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: |
          cd tests/intelligence
          pnpm install

      - name: Run Full Test Intelligence
        run: |
          cd tests/intelligence
          pnpm tsx cli.ts run full

      - name: Upload JUnit Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-report
          path: tests/intelligence/junit.xml

      - name: Upload Security Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: tests/intelligence/security-report.json

      - name: Upload Analytics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: analytics
          path: |
            tests/intelligence/analytics.json
            tests/intelligence/dashboard.html

  # Security-only scan
  security-scan:
    name: OWASP Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: 8

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: |
          cd tests/intelligence
          pnpm install

      - name: Run Security Scanner
        id: security
        run: |
          cd tests/intelligence
          pnpm tsx cli.ts security apps/web/app/api
        continue-on-error: true

      - name: Upload SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: tests/intelligence/security-report.json
        continue-on-error: true

      - name: Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const report = JSON.parse(fs.readFileSync('tests/intelligence/security-report.json', 'utf8'));
              const body = `## üîí Security Scan Results

**Security Score:** ${report.score}/100 (Grade: ${report.grade})

**Vulnerabilities Found:**
- üî¥ Critical: ${report.summary.critical}
- üü† High: ${report.summary.high}
- üü° Medium: ${report.summary.medium}
- üü¢ Low: ${report.summary.low}

${report.summary.critical > 0 ? '‚ö†Ô∏è **CRITICAL vulnerabilities detected! Review required.**' : ''}
`;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            } catch (err) {
              console.log('No security report found or error reading it:', err);
            }
