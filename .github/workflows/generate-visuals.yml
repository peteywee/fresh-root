# [P0][CI][AUTOMATION] Auto-generate Architecture & Repo Visuals
# Tags: P0, CI, AUTOMATION, VISUALS, MERMAID
#
# Triggers on every commit to dev/main
# Generates Mermaid diagrams for:
# - Architecture (structure, dependencies)
# - Repo state (branches, history)
# - Dependency health (vulnerabilities, peer deps)
# - File distribution (code metrics)
#
# Ensures ONLY latest versions in docs/visuals/ at all times

name: 'Automation: Generate Visuals & Architecture'

on:
  push:
    branches:
      - main
      - dev
    paths:
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'apps/**'
      - 'packages/**'
      - 'functions/**'
      - '.github/workflows/**'
      - '!docs/**'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-visuals:
    name: Generate Architecture & Repo Visuals
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 50

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9.12.1

      - name: Create docs/visuals directory
        run: mkdir -p docs/visuals

      - name: Generate visuals
        run: node scripts/generate-visuals.mjs --verbose
        env:
          NODE_OPTIONS: --max-old-space-size=4096

      - name: Check for changes
        id: check
        run: |
          if git diff --quiet docs/visuals/; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "## ðŸ“Š Generated Visuals" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Architecture diagrams updated" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Dependency analysis complete" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Repository state captured" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Commit and push if changed
        if: steps.check.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add docs/visuals/
          git commit -m "chore(visuals): auto-update architecture and repo state diagrams" \
            -m "- Architecture: monorepo structure and dependencies" \
            -m "- Repo State: branch status and git history" \
            -m "- Dependency Health: vulnerability and peer dep analysis" \
            -m "- File Distribution: code metrics and organization" \
            -m "" \
            -m "Generated by: automation/generate-visuals.yml"
          
          git push

      - name: Comment on PR if triggered by PR
        if: github.event_name == 'pull_request' && steps.check.outputs.changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸ“Š **Architecture & Repo Visuals Updated**\n\nCheck `docs/visuals/` for:\n- ðŸ—ï¸ Architecture diagram\n- ðŸ“Š Dependency tree\n- ðŸ“ˆ Repository state\n- ðŸ” Dependency health analysis\n- ðŸ“ File distribution metrics'
            });

  validate-dependency-health:
    name: Validate Dependency Health
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9.12.1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run security audit
        continue-on-error: true
        run: |
          echo "## ðŸ”’ Security Audit Results" >> $GITHUB_STEP_SUMMARY
          pnpm audit --json > audit-results.json 2>&1 || true
          
          if [ -f audit-results.json ]; then
            CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' audit-results.json)
            HIGH=$(jq '.metadata.vulnerabilities.high // 0' audit-results.json)
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ”´ Critical | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŸ  High | $HIGH |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Verify lock file integrity
        run: |
          echo "## ðŸ“¦ Lock File Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          pnpm ls --depth=0 --json > lockfile-status.json 2>&1 || true
          
          if [ -f lockfile-status.json ]; then
            PKG_COUNT=$(jq '.dependencies | length' lockfile-status.json)
            echo "âœ… Total packages: $PKG_COUNT" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Dependency tree check
        run: |
          echo "## ðŸŒ³ Dependency Tree" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          pnpm list --depth=0 | head -20 >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Tree diff analysis
        run: |
          echo "## ðŸ“Š Tree Diff Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ github.event.before }}" ]; then
            echo "### Changed Files" >> $GITHUB_STEP_SUMMARY
            git diff --name-only ${{ github.event.before }}..${{ github.sha }} | head -20 >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No previous commit available for comparison" >> $GITHUB_STEP_SUMMARY
          fi

  update-visuals-index:
    name: Update Visuals Index
    runs-on: ubuntu-latest
    needs: generate-visuals
    if: success()

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Update visuals README
        run: |
          cat > docs/visuals/README.md <<EOF
          # Repository Architecture & Visuals

          **Branch**: ${{ github.ref_name }}  
          **Updated**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')  
          **Commit**: ${{ github.sha }}

          These diagrams are **auto-generated on every commit** to \`main\` and \`dev\` branches.

          ## ðŸ“Š Available Visuals

          1. **[Architecture Diagram](./ARCHITECTURE.md)**
             - Monorepo structure (apps, packages, services)
             - Component dependencies and relationships
             - Technology stack overview

          2. **[Dependency Tree](./DEPENDENCIES.md)**
             - Package dependency graph
             - Critical dependency versions
             - Transitive dependencies

          3. **[Repository State](./REPO_STATE.md)**
             - Branch status and strategy
             - Git history timeline
             - Recent commits

          4. **[Dependency Health](./DEPENDENCY_HEALTH.md)**
             - Vulnerability audit results
             - Peer dependency issues
             - Deprecation warnings
             - Recommended fixes

          5. **[File Distribution](./FILE_DISTRIBUTION.md)**
             - Code metrics (TypeScript files, tests, docs)
             - File organization structure
             - Test coverage targets

          6. **[Status Timeline](./STATUS_TIMELINE.md)**
             - Development milestones
             - Project readiness status
             - Planned improvements

          ## ðŸ”„ Auto-Update Policy

          - **Trigger**: Every push to \`main\` or \`dev\`
          - **Workflow**: \`.github/workflows/generate-visuals.yml\`
          - **Only Latest**: Old versions automatically replaced
          - **CI-Mandated**: Required step in build pipeline

          ## ðŸ“– How to View

          ### In GitHub
          Mermaid diagrams render automatically in \`.md\` files

          ### Locally
          - VSCode: Install "Markdown Preview Mermaid Support"
          - Browser: https://mermaid.live (paste diagram code)

          ### In CI
          - Referenced in workflow summary reports
          - Attached to PR comments automatically

          ## ðŸš€ Regenerate Locally

          \`\`\`bash
          # Generate all visuals
          node scripts/generate-visuals.mjs

          # With verbose output
          node scripts/generate-visuals.mjs --verbose

          # Custom output directory
          node scripts/generate-visuals.mjs --output ./custom-output
          \`\`\`

          ## âš™ï¸ Maintenance

          The visual generation script automatically:
          1. Deletes previous versions (only latest in repo)
          2. Detects dependencies from \`pnpm list\`
          3. Analyzes repository state from git
          4. Runs security audits
          5. Generates Mermaid diagrams
          6. Updates this index file

          ---

          **Generated by**: Governance Automation  
          **Status**: âœ… Auto-maintained  
          **Last Update**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          EOF

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/visuals/README.md
          git commit -m "chore(visuals): update index and metadata" || echo "No changes"
          git push || echo "Nothing to push"
