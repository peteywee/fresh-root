name: CI Pipeline

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9.12.1'

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # GATE 1: STATIC ANALYSIS (TypeScript + ESLint)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  static:
    name: Static Analysis
    runs-on: ubuntu-latest
    if: ${{ !(github.event_name == 'push' && github.event.head_commit != null && contains(github.event.head_commit.message, '[skip ci]')) }}
    strategy:
      matrix:
        task: [typecheck, lint]
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install 

      - name: Run ${{ matrix.task }}
        run: pnpm ${{ matrix.task }}
        continue-on-error: ${{ matrix.task == 'lint' }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # GATE 2: SAFETY (Pattern Validation + Dependency Audit)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  safety:
    name: Safety & Security Checks
    runs-on: ubuntu-latest
    needs: static
    if: ${{ !(github.event_name == 'push' && github.event.head_commit != null && contains(github.event.head_commit.message, '[skip ci]')) }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Validate coding patterns
        run: |
          echo "ðŸ” Validating coding patterns..."
          pnpm validate:patterns:verbose || {
            echo "âŒ Pattern validation failed"
            exit 1
          }
        continue-on-error: false

      - name: Audit dependencies
        run: |
          echo "ðŸ” Running security audit..."
          pnpm deps:check
        continue-on-error: true

      - name: Analyze tree diff & deprecations
        run: |
          echo "ðŸ“Š Analyzing dependency tree..."
          pnpm deps:analyze || echo "âš ï¸ Tree diff completed with warnings"
        continue-on-error: true

      - name: Generate dependency report
        if: github.event_name == 'pull_request'
        run: |
          echo "ðŸ“ Generating dependency report..."
          pnpm deps:analyze:verbose > /tmp/deps-report.txt 2>&1 || true
          head -100 /tmp/deps-report.txt

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # GATE 3: TESTING (Unit Tests + Integration Tests + Coverage)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test:
    name: Testing Suite
    runs-on: ubuntu-latest
    needs: safety
    if: ${{ !(github.event_name == 'push' && github.event.head_commit != null && contains(github.event.head_commit.message, '[skip ci]')) }}
    strategy:
      matrix:
        test-type:
          - unit
          - rules
          - e2e
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Setup Firebase Emulator
        if: matrix.test-type == 'rules' || matrix.test-type == 'e2e'
        run: |
          npm install -g firebase-tools
          echo "âœ… Firebase Emulator setup ready"

      - name: Run unit tests
        if: matrix.test-type == 'unit'
        run: |
          echo "ðŸ§ª Running unit tests..."
          pnpm test 2>&1 | tee /tmp/test-output.txt
          echo "âœ… Unit tests completed"

      - name: Run Firestore rules tests
        if: matrix.test-type == 'rules'
        run: |
          echo "ðŸ”¥ Running Firestore rules tests..."
          pnpm test:rules
        continue-on-error: false

      - name: Start Firebase Emulators for E2E
        if: matrix.test-type == 'e2e'
        run: |
          echo "ðŸ”¥ Starting Firebase Emulators..."
          firebase emulators:start --only auth,firestore,storage &
          sleep 10
          echo "âœ… Emulators started"

      - name: Run E2E tests
        if: matrix.test-type == 'e2e'
        run: |
          echo "ðŸŽ­ Running E2E tests..."
          pnpm test:e2e || echo "âš ï¸ E2E tests: check output above"
        continue-on-error: true

      - name: Stop Firebase Emulators
        if: matrix.test-type == 'e2e' && always()
        run: |
          pkill -f "firebase emulators" || true
          echo "âœ… Emulators stopped"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # GATE 4: BUILD VERIFICATION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build:
    name: Build Verification
    runs-on: ubuntu-latest
    needs: test
    if: ${{ !(github.event_name == 'push' && github.event.head_commit != null && contains(github.event.head_commit.message, '[skip ci]')) }}
    permissions:
      contents: write
    env:
      # Firebase Configuration
      NEXT_PUBLIC_FIREBASE_API_KEY: ${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}
      NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ secrets.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}
      NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}
      NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ secrets.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}
      NEXT_PUBLIC_FIREBASE_APP_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID }}
      NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}
      NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID }}
      FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
      # Application Configuration
      PORT: ${{ secrets.PORT }}
      API_BASE_URL: ${{ secrets.API_BASE_URL }}
      BYPASS_ONBOARDING_GUARD: ${{ secrets.BYPASS_ONBOARDING_GUARD }}
      NODE_OPTIONS: ${{ secrets.NODE_OPTIONS }}
      SWC_NUM_THREADS: ${{ secrets.SWC_NUM_THREADS }}
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # START: Performance tracking
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ“Š Start performance tracking
        id: perf-start
        run: |
          echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT
          echo "workflow_start=$(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

      - name: Install dependencies
        id: install-deps
        run: |
          INSTALL_START=$(date +%s)
          pnpm install --frozen-lockfile
          INSTALL_END=$(date +%s)
          echo "duration=$((INSTALL_END - INSTALL_START))" >> $GITHUB_OUTPUT

      - name: Cache Next.js build
        id: cache-nextjs
        uses: actions/cache@v4
        with:
          path: |
            apps/web/.next/cache
            .turbo
          key: ${{ runner.os }}-nextjs-${{ hashFiles('pnpm-lock.yaml') }}-${{ hashFiles('apps/web/**/*.ts', 'apps/web/**/*.tsx', 'packages/**/*.ts') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('pnpm-lock.yaml') }}-
            ${{ runner.os }}-nextjs-

      - name: Build all packages
        id: build-packages
        run: |
          BUILD_START=$(date +%s)
          echo "ðŸ—ï¸ Building all packages..."
          pnpm build
          BUILD_END=$(date +%s)
          echo "duration=$((BUILD_END - BUILD_START))" >> $GITHUB_OUTPUT

      - name: Build SDK
        id: build-sdk
        run: |
          SDK_START=$(date +%s)
          echo "ðŸ”¨ Building SDK framework..."
          pnpm build:sdk
          SDK_END=$(date +%s)
          echo "duration=$((SDK_END - SDK_START))" >> $GITHUB_OUTPUT

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # END: Generate performance report
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ“Š Generate Performance Report
        if: always()
        run: |
          END_TIME=$(date +%s)
          TOTAL_DURATION=$((END_TIME - ${{ steps.perf-start.outputs.start_time }}))
          INSTALL_TIME="${{ steps.install-deps.outputs.duration || '0' }}"
          BUILD_TIME="${{ steps.build-packages.outputs.duration || '0' }}"
          SDK_TIME="${{ steps.build-sdk.outputs.duration || '0' }}"
          CACHE_HIT="${{ steps.cache-nextjs.outputs.cache-hit }}"

          # Determine cache status emoji
          if [ "$CACHE_HIT" = "true" ]; then
            CACHE_EMOJI="âœ…"
            CACHE_STATUS="HIT"
          else
            CACHE_EMOJI="âŒ"
            CACHE_STATUS="MISS"
          fi

          # Identify bottleneck
          BOTTLENECK="None"
          if [ "$BUILD_TIME" -gt 180 ]; then
            BOTTLENECK="âš ï¸ Package build (${BUILD_TIME}s > 180s target)"
          elif [ "$SDK_TIME" -gt 120 ]; then
            BOTTLENECK="âš ï¸ SDK build (${SDK_TIME}s > 120s target)"
          elif [ "$INSTALL_TIME" -gt 60 ]; then
            BOTTLENECK="âš ï¸ Dependency install (${INSTALL_TIME}s > 60s target)"
          fi

          # Write to job summary
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## ðŸ“Š Build Performance Report

          **Run**: [\`${GITHUB_RUN_ID}\`](https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID})
          **Commit**: [\`${GITHUB_SHA:0:7}\`](https://github.com/${GITHUB_REPOSITORY}/commit/${GITHUB_SHA})
          **Started**: ${{ steps.perf-start.outputs.workflow_start }}

          ### â±ï¸ Timing Breakdown

          | Phase | Duration | Status |
          |-------|----------|--------|
          | Dependency Install | ${INSTALL_TIME}s | $([ "$INSTALL_TIME" -lt 60 ] && echo "âœ…" || echo "âš ï¸") |
          | Next.js Cache | - | $CACHE_EMOJI $CACHE_STATUS |
          | Package Build | ${BUILD_TIME}s | $([ "$BUILD_TIME" -lt 180 ] && echo "âœ…" || echo "âš ï¸") |
          | SDK Build | ${SDK_TIME}s | $([ "$SDK_TIME" -lt 120 ] && echo "âœ…" || echo "âš ï¸") |
          | **Total Duration** | **${TOTAL_DURATION}s** | $([ "$TOTAL_DURATION" -lt 360 ] && echo "âœ…" || echo "âš ï¸") |

          ### ðŸŽ¯ Performance Targets

          - Install: <60s
          - Package Build: <180s (with cache), <300s (without)
          - SDK Build: <120s
          - Total: <360s (6 min)

          ### ðŸ” Bottleneck Analysis

          **Detected**: $BOTTLENECK

          ### ðŸ“ˆ Cache Efficiency

          - Next.js Cache Hit: **$CACHE_HIT**
          - Cache Key: \`${{ runner.os }}-nextjs-${{ hashFiles('pnpm-lock.yaml') }}-${{ hashFiles('apps/web/**/*.ts', 'apps/web/**/*.tsx', 'packages/**/*.ts') }}\`

          ---

          _ðŸ’¡ To improve performance: ensure cache hits, use \`pnpm install --prefer-offline\`, optimize bundle splits_
          EOF

          # Also output to console for quick viewing
          echo "=========================================="
          echo "ðŸ“Š BUILD PERFORMANCE SUMMARY"
          echo "=========================================="
          echo "Total Duration: ${TOTAL_DURATION}s"
          echo "Cache Hit: $CACHE_HIT"
          echo "Bottleneck: $BOTTLENECK"
          echo "=========================================="

      - name: Persist build performance metrics (time-series)
        if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main'
        continue-on-error: true
        run: |
          mkdir -p docs/metrics

          TS=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          INSTALL_TIME="${{ steps.install-deps.outputs.duration }}"
          BUILD_TIME="${{ steps.build-packages.outputs.duration }}"
          SDK_TIME="${{ steps.build-sdk.outputs.duration }}"
          CACHE_HIT="${{ steps.cache-nextjs.outputs.cache-hit }}"
          TOTAL_SECONDS=$(( $(date +%s) - ${{ steps.perf-start.outputs.start_time }} ))

          INSTALL_TIME=${INSTALL_TIME:-0}
          BUILD_TIME=${BUILD_TIME:-0}
          SDK_TIME=${SDK_TIME:-0}
          CACHE_HIT=${CACHE_HIT:-""}

          cat >> docs/metrics/build-performance.log <<EOF
          {"timestamp":"$TS","repository":"$GITHUB_REPOSITORY","ref":"$GITHUB_REF","sha":"$GITHUB_SHA","runId":"$GITHUB_RUN_ID","runAttempt":"$GITHUB_RUN_ATTEMPT","installSeconds":$INSTALL_TIME,"buildSeconds":$BUILD_TIME,"sdkSeconds":$SDK_TIME,"totalSeconds":$TOTAL_SECONDS,"cacheHit":"$CACHE_HIT"}
          EOF

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add docs/metrics/build-performance.log
          git diff --cached --quiet && exit 0
          git commit -m "chore(metrics): append build performance [skip ci]" || true
          git fetch origin main
          git rebase origin/main || git rebase --abort || true
          git push origin HEAD:main || true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SUMMARY: Status Check
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ci-summary:
    name: CI Status Summary
    runs-on: ubuntu-latest
    needs: [static, safety, test, build]
    if: ${{ always() && !(github.event_name == 'push' && github.event.head_commit != null && contains(github.event.head_commit.message, '[skip ci]')) }}
    steps:
      - name: Check CI Status
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                   CI PIPELINE SUMMARY                      â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… GATE 1 (Static): ${{ needs.static.result }}"
          echo "âœ… GATE 2 (Safety): ${{ needs.safety.result }}"
          echo "âœ… GATE 3 (Tests):  ${{ needs.test.result }}"
          echo "âœ… GATE 4 (Build):  ${{ needs.build.result }}"
          echo ""
          
          if [ "${{ needs.static.result }}" = "failure" ]; then
            echo "âŒ Static analysis failed - fix typecheck/lint errors"
            exit 1
          fi
          
          if [ "${{ needs.test.result }}" = "failure" ]; then
            echo "âŒ Tests failed - fix failing test cases"
            exit 1
          fi
          
          if [ "${{ needs.build.result }}" = "failure" ]; then
            echo "âŒ Build failed - verify production build"
            exit 1
          fi
          
          echo "âœ¨ All gates passed!"
          echo ""
          echo "Next: Create a pull request to merge changes"

      - name: PR Comment (on PR)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `
            ## âœ… CI Pipeline Summary
            
            | Gate | Status | Details |
            |------|--------|---------|
            | Static Analysis | ${{ needs.static.result }} | TypeScript + ESLint |
            | Safety Checks | ${{ needs.safety.result }} | Patterns + Audit |
            | Testing | ${{ needs.test.result }} | Unit + Rules tests |
            | Build | ${{ needs.build.result }} | All packages |
            
            **Thresholds**:
            - PR Merge Gate: 70% coverage
            - Main Branch Gate: 80% coverage
            
            [View full logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
