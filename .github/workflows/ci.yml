  - name: Set up Node.js
    uses: actions/setup-node@v4
    with:
      node-version: "20"
      cache: "pnpm"

  - name: Set up pnpm
    uses: pnpm/action-setup@v2
    with:
      version: "8"

  - name: Restore firebase emulators cache
    uses: actions/cache@v4
    with:
      path: ~/.cache/firebase/emulators
      key: Linux-firebase-emulators-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
      restore-keys: Linux-firebase-emulators-

  - name: Install dependencies
    run: pnpm install --frozen-lockfile

  # WORKAROUND: ensure require-in-the-middle is present for Turbopack/next build
  - name: CI workaround: install require-in-the-middle (no workspace changes)
    run: pnpm add -w require-in-the-middle --no-save

  - name: Lint
    run: pnpm -w lint
    continue-on-error: false

  - name: Test
    run: pnpm -w test --if-present

  - name: Build (monorepo)
    run: pnpm -w -r build

  - name: Post job cleanup
    if: always()
    run: echo "CI job finished"
