# [P0][CI][WORKFLOW] Main branch merge gate
# Tags: P0, CI, WORKFLOW, GOVERNANCE

name: Main Branch Merge Gate

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

permissions:
  pull-requests: write
  contents: read

jobs:
  enforce-merge-rules:
    runs-on: ubuntu-latest
    name: Enforce main branch merge rules

    steps:
      - name: Check source branch
        id: source
        run: |
          SOURCE="${{ github.head_ref }}"
          if [ "$SOURCE" != "dev" ]; then
            echo "ERROR: Can only merge to main from dev branch"
            exit 1
          fi
          echo "✅ Source branch is dev"

      - name: Verify PR description
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            
            if (!pr.body || pr.body.length < 50) {
              core.setFailed("❌ PR description is required and should include release notes");
            }
            
            if (!pr.body.includes("## Changes") && 
                !pr.body.includes("## Release Notes") &&
                !pr.body.includes("## What's New")) {
              core.setFailed("❌ PR should include a Changes/Release Notes section");
            }

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify no docs/tests/logs in main
        id: file-check
        run: |
          INVALID=$(git diff --name-only origin/main...HEAD | \
            grep -E '\.(log|report|metrics|e2e\.ts|spec\.ts)$' || true)
          
          if [ -n "$INVALID" ]; then
            echo "ERROR: Main branch cannot contain test/log files:"
            echo "$INVALID"
            exit 1
          fi
          echo "✅ File patterns valid for main"

      - name: Add enforcement comment
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `✅ **Main Branch Merge Gate: PASSED**\n\n**Checks:**\n- [x] Source branch is dev\n- [x] File patterns valid (no docs/tests/logs)\n- [x] PR has release notes\n\n**Next:** Requires 2 approvals before merge to production`
            })

      - name: Block merge on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `❌ **Main Branch Merge Gate: FAILED**\n\n**Requirements to merge to main:**\n1. Source must be **dev** branch (not feature branches)\n2. No docs/tests/logs files\n3. PR must include release notes\n4. Requires 2 approvals\n\n**How to fix:**\n1. Ensure PR is from dev → main\n2. Move any docs/test files to docs-tests-logs\n3. Add release notes to PR description`
            })
