name: PR Feedback

on:
  pull_request:
    types: [opened, synchronize, reopened]

# Limit concurrency for PR feedback
concurrency:
  group: pr-feedback-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9.12.1'

jobs:
  pr-info:
    name: PR Information
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR stats
        id: pr-stats
        run: |
          echo "files_changed=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)" >> $GITHUB_OUTPUT
          echo "commits=$(git rev-list --count origin/${{ github.base_ref }}..HEAD)" >> $GITHUB_OUTPUT
          echo "additions=$(git diff --shortstat origin/${{ github.base_ref }}...HEAD | grep -oP '\d+(?= insertion)' || echo 0)" >> $GITHUB_OUTPUT
          echo "deletions=$(git diff --shortstat origin/${{ github.base_ref }}...HEAD | grep -oP '\d+(?= deletion)' || echo 0)" >> $GITHUB_OUTPUT

      - name: Comment PR info
        uses: actions/github-script@v7
        with:
          script: |
            const stats = {
              files: '${{ steps.pr-stats.outputs.files_changed }}',
              commits: '${{ steps.pr-stats.outputs.commits }}',
              additions: '${{ steps.pr-stats.outputs.additions }}',
              deletions: '${{ steps.pr-stats.outputs.deletions }}'
            };
            
            const body = `## ðŸ“Š PR Statistics
            
            | Metric | Value |
            |--------|-------|
            | Files Changed | ${stats.files} |
            | Commits | ${stats.commits} |
            | Lines Added | +${stats.additions} |
            | Lines Deleted | -${stats.deletions} |
            
            > ðŸ¤– Auto-generated by PR Feedback workflow
            `;
            
            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const existingComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('PR Statistics')
            );
            
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  size-check:
    name: Bundle Size Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Check bundle size
        run: |
          if [ -d "apps/web/.next" ]; then
            echo "ðŸ“¦ Next.js Build Size:"
            du -sh apps/web/.next
            echo ""
            echo "ðŸ“Š Detailed breakdown:"
            du -sh apps/web/.next/* 2>/dev/null || echo "No detailed stats available"
          fi
          
          if [ -d "packages" ]; then
            echo ""
            echo "ðŸ“¦ Package sizes:"
            find packages -name "dist" -type d -exec du -sh {} \; 2>/dev/null || echo "No package builds found"
          fi
