# [P0][CI][WORKFLOW] Branch file pattern validation
# Tags: P0, CI, WORKFLOW, GOVERNANCE

name: Branch File Pattern Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read

jobs:
  validate-branch-files:
    runs-on: ubuntu-latest
    name: Validate file patterns for target branch

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine target branch
        id: branch
        run: |
          TARGET=${GITHUB_BASE_REF}
          case "$TARGET" in
            main|dev|docs-tests-logs)
              echo "branch_type=$TARGET" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "branch_type=feature" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Get changed files
        id: files
        run: |
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Validate file patterns
        id: validate
        run: |
          node scripts/validate-branch-files.js \
            "${{ steps.branch.outputs.branch_type }}" \
            "${{ steps.files.outputs.files }}"

      - name: Add comment on validation failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚ùå **Branch File Pattern Validation Failed**\n\nSome files don't match the patterns allowed for the **${{ steps.branch.outputs.branch_type }}** branch.\n\nüìã **Rule Reference:**\n- **main**: Production code only (no docs/tests/logs)\n- **dev**: Code + feature tests\n- **docs-tests-logs**: Documentation, test results, reports\n- **feature**: Code + feature tests\n\nPlease move files to the correct branch or PR.`
            })
