name: Auto-Generate Tests (Coverage Threshold Failure)

on:
  # Trigger when test coverage falls below thresholds
  workflow_dispatch:
    inputs:
      force_generation:
        description: "Force test generation even if coverage is acceptable"
        required: false
        default: "false"
  # Also on-demand as part of test-coverage.yml
  # See: test-coverage.yml for integration points

permissions:
  contents: write
  pull-requests: write

jobs:
  check-coverage-and-generate:
    runs-on: ubuntu-latest
    name: Check Coverage & Auto-Generate Missing Tests

    strategy:
      matrix:
        node-version: [20.10.0]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9.12.1

      - name: Setup pnpm cache
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run test coverage analysis
        id: coverage
        run: |
          echo "=== Running Test Coverage Analysis ==="
          
          # Capture coverage metrics
          UNIT_COVERAGE=$(pnpm test -- --coverage 2>/dev/null | grep -oP 'Statements\s+:\s+\K[\d.]+' || echo "0")
          INTEGRATION_COVERAGE=$(pnpm test:integration 2>/dev/null | wc -l | awk '{print 0}' || echo "0")
          
          echo "unit_coverage=$UNIT_COVERAGE" >> $GITHUB_OUTPUT
          echo "integration_coverage=$INTEGRATION_COVERAGE" >> $GITHUB_OUTPUT
          
          echo "âœ… Coverage Analysis Complete"
          echo "   Unit Tests: ${UNIT_COVERAGE}%"
          echo "   Integration Tests: ${INTEGRATION_COVERAGE}%"

      - name: Check coverage thresholds
        id: check_thresholds
        run: |
          echo "=== Checking Coverage Thresholds ==="
          
          UNIT_COVERAGE=${{ steps.coverage.outputs.unit_coverage }}
          INTEGRATION_COVERAGE=${{ steps.coverage.outputs.integration_coverage }}
          UNIT_THRESHOLD=90
          INTEGRATION_THRESHOLD=80
          
          UNIT_BELOW=$(echo "$UNIT_COVERAGE < $UNIT_THRESHOLD" | bc -l)
          INTEGRATION_BELOW=$(echo "$INTEGRATION_COVERAGE < $INTEGRATION_THRESHOLD" | bc -l)
          
          if [[ "$UNIT_BELOW" == "1" ]] || [[ "$INTEGRATION_BELOW" == "1" ]] || [[ "${{ github.event.inputs.force_generation }}" == "true" ]]; then
            echo "generate_tests=true" >> $GITHUB_OUTPUT
            echo "âš ï¸  Coverage below thresholds - WILL GENERATE TESTS"
          else
            echo "generate_tests=false" >> $GITHUB_OUTPUT
            echo "âœ… Coverage meets thresholds - NO GENERATION NEEDED"
          fi

      - name: Auto-generate test templates
        if: steps.check_thresholds.outputs.generate_tests == 'true'
        run: |
          echo "=== Auto-Generating Test Templates ==="
          node scripts/tests/auto-generate-tests.mjs
          
          echo ""
          echo "Generated Files:"
          git status --short | grep "??" || echo "  (no new files)"

      - name: Create summary report
        if: always()
        run: |
          cat > /tmp/coverage-report.md << 'EOF'
          # Test Coverage Status Report
          
          **Generated**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          **Branch**: ${{ github.ref_name }}
          **Trigger**: ${{ github.event_name }}
          
          ## Coverage Summary
          
          | Layer | Target | Status |
          |-------|--------|--------|
          | Unit Tests | â‰¥90% | ${{ steps.coverage.outputs.unit_coverage || 'â„¹ï¸ Pending' }}% |
          | Integration Tests | â‰¥80% | ${{ steps.coverage.outputs.integration_coverage || 'â„¹ï¸ Pending' }}% |
          | E2E Tests | â‰¥70% | â„¹ï¸ Pending |
          | **Overall** | **â‰¥85%** | **â„¹ï¸ Pending** |
          
          ## Actions Taken
          
          - âœ… Coverage thresholds checked
          - ${{ steps.check_thresholds.outputs.generate_tests == 'true' && 'âœ… Test templates auto-generated' || 'âœ… No generation needed - coverage sufficient' }}
          - â„¹ï¸ Review generated files below
          
          ## Generated Files
          
          \`\`\`
          $(git status --short | grep "??" | head -20 || echo "No new files")
          \`\`\`
          
          ## Next Steps
          
          1. Review auto-generated test templates
          2. Fill in TODO sections with test logic
          3. Run: `pnpm test` to verify
          4. Commit when coverage meets thresholds
          5. Coverage must be:
             - Unit: â‰¥90%
             - Integration: â‰¥80%
             - E2E: â‰¥70%
             - Overall: â‰¥85%
          
          **Automation**: This workflow automatically generates test templates when coverage falls below thresholds.
          EOF
          
          cat /tmp/coverage-report.md

      - name: Commit auto-generated tests
        if: steps.check_thresholds.outputs.generate_tests == 'true'
        run: |
          git config user.name "GitHub Actions (Test Auto-Generator)"
          git config user.email "actions+test-generator@github.com"
          
          if [[ -n $(git status -s) ]]; then
            echo "=== Committing Auto-Generated Test Templates ==="
            git add apps/web/app/api/__tests__/ packages/**/__tests__/
            git commit -m "chore(tests): auto-generate test templates for coverage gaps
            
- Unit test templates (â‰¥90% target)
- Integration test templates (â‰¥80% target)
- Module test templates
- Review and complete TODO sections
- Tests are ready to implement" --no-verify || echo "âš ï¸  No changes to commit"
            
            git push || echo "âš ï¸  Push skipped - may need permissions"
            
            echo ""
            echo "âœ… Auto-generated test templates committed"
            echo "ðŸ“ Next: Implement test logic in generated files"
          else
            echo "âœ… No test changes to commit"
          fi

      - name: Report summary
        if: always()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘          TEST AUTO-GENERATION WORKFLOW COMPLETE             â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ“Š Coverage Status:"
          echo "   Unit Tests:        ${{ steps.coverage.outputs.unit_coverage || 'â³ Pending' }}% (target: â‰¥90%)"
          echo "   Integration Tests: ${{ steps.coverage.outputs.integration_coverage || 'â³ Pending' }}% (target: â‰¥80%)"
          echo ""
          echo "ðŸ”§ Actions:"
          echo "   Test Generation:   ${{ steps.check_thresholds.outputs.generate_tests == 'true' && 'âœ… COMPLETED' || 'â­ï¸  SKIPPED (coverage sufficient)' }}"
          echo "   Commit:            ${{ steps.check_thresholds.outputs.generate_tests == 'true' && 'âœ… YES' || 'â­ï¸  N/A' }}"
          echo ""
          echo "ðŸ“‹ Thresholds:"
          echo "   Unit Tests:        â‰¥90% (HARD REQUIREMENT)"
          echo "   Integration Tests: â‰¥80% (HARD REQUIREMENT)"
          echo "   E2E Tests:         â‰¥70% (HARD REQUIREMENT)"
          echo "   Overall:           â‰¥85% (HARD REQUIREMENT)"
          echo ""
          echo "ðŸ’¡ Manual Trigger:"
          echo "   To force test generation: gh workflow run auto-generate-tests.yml -f force_generation=true"
          echo ""
