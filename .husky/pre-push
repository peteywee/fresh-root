#!/bin/sh

# Pre-push: gate on typecheck, lint, and Repomix analysis
# Add a way to skip checks locally to avoid expensive memory usage:
# - Set SKIP_CHECKS=1 to skip all checks
# - Set SKIP_LINT=1 to skip only the lint step
# - Set SKIP_REPOMIX=1 to skip Repomix dependency check
# - Set SKIP_SYNCPACK=1 to skip syncpack version validation

if [ -n "$SKIP_CHECKS" ]; then
	echo "[husky] SKIP_CHECKS set ‚Äî skipping all pre-push checks."
	exit 0
fi

# Syncpack version validation (guardrails). Set SKIP_SYNCPACK=1 to skip.
if [ -n "$SKIP_SYNCPACK" ]; then
	echo "[husky] SKIP_SYNCPACK set ‚Äî skipping syncpack."
else
	echo "üì¶ Validating dependency versions..."
	pnpm -w syncpack list-mismatches >/dev/null 2>&1
	if [ $? -ne 0 ]; then
		echo "‚ö†Ô∏è Version mismatches found (run 'pnpm deps:sync:check' for details)"
	fi
fi

# Always run typecheck by default (keeps CI safety). Set SKIP_TYPECHECK=1 to skip it.
if [ -n "$SKIP_TYPECHECK" ]; then
	echo "[husky] SKIP_TYPECHECK set ‚Äî skipping typecheck."
else
	echo "üîç Running typecheck..."
	pnpm -w typecheck || exit 1
fi

# Lint can be expensive in watch mode on low-memory machines ‚Äî allow opt-out.
if [ -n "$SKIP_LINT" ]; then
	echo "[husky] SKIP_LINT set ‚Äî skipping lint step."
else
	echo "üîç Running lint..."
	pnpm -w lint || exit 1
fi

# Repomix dependency check (lightweight). Set SKIP_REPOMIX=1 to skip it.
if [ -n "$SKIP_REPOMIX" ]; then
	echo "[husky] SKIP_REPOMIX set ‚Äî skipping Repomix check."
else
	echo "üß† Running Repomix dependency analysis..."
	pnpm repomix . --style json --output .repomix-cache.json --compress || {
		echo "‚ö†Ô∏è Repomix check failed (non-blocking)"
	}
fi

echo "‚úÖ Pre-push checks passed."
