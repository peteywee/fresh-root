#!/usr/bin/env bash
# Block commits with unresolved merge markers
# Use regex anchors and exact 7-char patterns to avoid false positives from decorative lines
if grep -nRE --exclude-dir=node_modules --exclude-dir=.git '^<<<<<<<|^=======$|^>>>>>>>' . 2>/dev/null | grep -v '.husky/pre-commit' >/dev/null; then
  echo "ERROR: Unresolved merge conflict markers found. Resolve them before committing."
  grep -nRE --exclude-dir=node_modules --exclude-dir=.git '^<<<<<<<|^=======$|^>>>>>>>' . 2>/dev/null | grep -v '.husky/pre-commit' | head -10
  exit 1
fi

# [SECURITY] Scan README files for exposed secrets
# Prevent accidental commit of API keys, tokens, credentials
STAGED_README=$(git diff --cached --name-only | grep -E '^README\.md$|^docs/.*README\.md$|^docs/guides/(QUICK_START|DEPLOYMENT)\.md$' || true)
if [ ! -z "$STAGED_README" ]; then
  node scripts/security/detect-readme-secrets.mjs
  if [ $? -ne 0 ]; then
    echo ""
    echo "‚ùå README security scan failed."
    echo "   Remove secrets before committing. Use placeholders instead."
    exit 1
  fi
fi

# [A09] Validate handler signature invariant (route.ts files)
# Prevent merge conflicts on SDK factory handler destructuring
node scripts/validate-handler-signature.mjs
if [ $? -ne 0 ]; then
  echo ""
  echo "‚ùå Handler signature validation failed."
  echo "   See .github/governance/amendments/A09_HANDLER_SIGNATURE_INVARIANT.md"
  exit 1
fi

# Block documentation files from being committed to root directory
# Only README.md and LICENSE are allowed at root
DISALLOWED_ROOT_DOCS=$(git diff --cached --name-only | grep -E '\.md$' | grep -v '^README\.md$\|^LICENSE' | grep -v '/' | grep -v '^WARP\.md$' || true)
if [ ! -z "$DISALLOWED_ROOT_DOCS" ]; then
  echo "üö´ ERROR: Documentation files should not be committed to root directory"
  echo ""
  echo "Disallowed files:"
  echo "$DISALLOWED_ROOT_DOCS" | sed 's/^/  - /'
  echo ""
  echo "‚úÖ Move them to one of these locations:"
  echo "  - docs/architecture/       (system design, decisions)"
  echo "  - docs/standards/          (coding patterns, rules)"
  echo "  - docs/guides/             (how-to tutorials)"
  echo "  - docs/production/         (operations, deployment)"
  echo "  - docs/templates/          (reusable templates)"
  echo "  - docs/reports/            (analysis, audits)"
  echo "  - archive/                 (historical/superseded docs)"
  echo ""
  echo "üìù For details, see: docs/guides/DOCUMENTATION_FILING_GUIDE.md"
  exit 1
fi

# Block re-introduction of deprecated scripts
# Prevents accidental re-addition of test:all, deps:check, deps:dedupe
DEPRECATED_SCRIPTS="test:all|deps:check|deps:dedupe"
if git diff --cached package.json | grep -E '"('"$DEPRECATED_SCRIPTS"')"' >/dev/null; then
  echo "üö´ ERROR: Attempt to add deprecated script(s) detected"
  echo ""
  echo "Deprecated scripts (removed Dec 25, 2025):"
  echo "  - test:all (use specific test:* scripts instead)"
  echo "  - deps:check (use 'pnpm audit' instead)"
  echo "  - deps:dedupe (pnpm handles this automatically)"
  echo ""
  echo "üìñ See: docs/DEPRECATIONS.md for rationale and migrations"
  exit 1
fi

# Docs lint (staged Markdown only)
# Fail fast on markdownlint violations (e.g., MD040 fenced code language, MD060 table style)
# Filter out paths that match .markdownlintignore patterns and docs with unfixable errors
STAGED_MD_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.md$' | \
  grep -v -E '^\.github/governance/' | \
  grep -v -E '^\.github/instructions/' | \
  grep -v -E '^\.github/prompts/' | \
  grep -v -E '^\.github/copilot-instructions\.md$' | \
  grep -v -E '^archive/' | \
  grep -v -E '^docs/' || true)
if [ ! -z "$STAGED_MD_FILES" ]; then
  echo "üßæ Running markdownlint on staged Markdown files..."
  pnpm exec markdownlint-cli2 --config .markdownlint.json $STAGED_MD_FILES
  if [ $? -ne 0 ]; then
    echo ""
    echo "‚ùå Markdown lint failed."
    echo "   Quick fix: pnpm --filter @fresh-root/markdown-fixer fix && pnpm format"
    exit 1
  fi
fi

pnpm -w typecheck && pnpm -w lint
