#!/usr/bin/env bash
# Block commits with unresolved merge markers
# Use regex anchors and exact 7-char patterns to avoid false positives from decorative lines
if grep -nRE --exclude-dir=node_modules --exclude-dir=.git '^<<<<<<<|^=======$|^>>>>>>>' . 2>/dev/null | grep -v '.husky/pre-commit' >/dev/null; then
  echo "ERROR: Unresolved merge conflict markers found. Resolve them before committing."
  grep -nRE --exclude-dir=node_modules --exclude-dir=.git '^<<<<<<<|^=======$|^>>>>>>>' . 2>/dev/null | grep -v '.husky/pre-commit' | head -10
  exit 1
fi

# Block documentation files from being committed to root directory
# Only README.md and LICENSE are allowed at root
DISALLOWED_ROOT_DOCS=$(git diff --cached --name-only | grep -E '\.md$' | grep -v '^README\.md$\|^LICENSE' | grep -v '/' | grep -v '^WARP\.md$' || true)
if [ ! -z "$DISALLOWED_ROOT_DOCS" ]; then
  echo "üö´ ERROR: Documentation files should not be committed to root directory"
  echo ""
  echo "Disallowed files:"
  echo "$DISALLOWED_ROOT_DOCS" | sed 's/^/  - /'
  echo ""
  echo "‚úÖ Move them to one of these locations:"
  echo "  - docs/architecture/       (system design, decisions)"
  echo "  - docs/standards/          (coding patterns, rules)"
  echo "  - docs/guides/             (how-to tutorials)"
  echo "  - docs/production/         (operations, deployment)"
  echo "  - docs/templates/          (reusable templates)"
  echo "  - docs/reports/            (analysis, audits)"
  echo "  - archive/                 (historical/superseded docs)"
  echo ""
  echo "üìù For details, see: docs/guides/DOCUMENTATION_FILING_GUIDE.md"
  exit 1
fi

pnpm -w typecheck && pnpm -w lint
