<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#0f172a">
  <title>Test Intelligence Dashboard</title>
  <link rel="manifest" href="/manifest.json">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #0f172a; --surface: #1e293b; --border: #334155;
      --text: #e2e8f0; --muted: #94a3b8; --primary: #3b82f6;
      --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg); color: var(--text); line-height: 1.6;
    }
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    header {
      background: var(--surface); padding: 20px; border-radius: 12px;
      margin-bottom: 20px; border: 1px solid var(--border);
    }
    h1 { font-size: 28px; margin-bottom: 8px; }
    .subtitle { color: var(--muted); font-size: 14px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
    .card {
      background: var(--surface); border-radius: 12px; padding: 20px;
      border: 1px solid var(--border); transition: transform 0.2s;
    }
    .card:hover { transform: translateY(-2px); }
    .card-title { font-size: 14px; color: var(--muted); margin-bottom: 8px; text-transform: uppercase; }
    .card-value { font-size: 32px; font-weight: bold; margin-bottom: 4px; }
    .card-change { font-size: 12px; }
    .badge {
      display: inline-block; padding: 4px 12px; border-radius: 20px;
      font-size: 12px; font-weight: 600;
    }
    .badge-success { background: rgba(16, 185, 129, 0.2); color: var(--success); }
    .badge-warning { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
    .badge-danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
    .btn {
      padding: 10px 20px; border-radius: 8px; border: none;
      font-weight: 600; cursor: pointer; transition: all 0.2s;
    }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: #2563eb; }
    .btn-secondary { background: var(--surface); color: var(--text); border: 1px solid var(--border); }
    .list { list-style: none; }
    .list-item {
      padding: 12px; border-bottom: 1px solid var(--border);
      display: flex; justify-content: space-between; align-items: center;
    }
    .list-item:last-child { border-bottom: none; }
    .chart { width: 100%; height: 200px; margin-top: 16px; }
    .status { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; }
    .status-success { background: var(--success); }
    .status-warning { background: var(--warning); }
    .status-danger { background: var(--danger); }
    .loading {
      display: inline-block; width: 16px; height: 16px;
      border: 2px solid var(--border); border-top-color: var(--primary);
      border-radius: 50%; animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .tab-nav {
      display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 1px solid var(--border);
    }
    .tab {
      padding: 12px 20px; cursor: pointer; border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    .tab:hover { color: var(--primary); }
    .tab.active { color: var(--primary); border-bottom-color: var(--primary); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    #console {
      background: #000; color: #0f0; padding: 16px; border-radius: 8px;
      font-family: 'Courier New', monospace; font-size: 12px; height: 300px;
      overflow-y: auto; white-space: pre-wrap;
    }
    .metric { display: flex; justify-content: space-between; padding: 8px 0; }
    .progress {
      width: 100%; height: 8px; background: var(--border);
      border-radius: 4px; overflow: hidden; margin-top: 8px;
    }
    .progress-bar {
      height: 100%; background: var(--primary);
      transition: width 0.3s ease;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üß† Test Intelligence Dashboard</h1>
      <p class="subtitle">AI-Powered Testing ‚Ä¢ Real-time Analytics ‚Ä¢ Cross-Platform</p>
      <div style="margin-top: 12px; display: flex; gap: 12px;">
        <button class="btn btn-primary" onclick="runFull()">‚ñ∂ Run Full Suite</button>
        <button class="btn btn-secondary" onclick="runQuick()">‚ö° Quick Check</button>
        <button class="btn btn-secondary" onclick="refreshAll()">üîÑ Refresh</button>
        <span id="status" style="margin-left: auto; display: flex; align-items: center;"></span>
      </div>
    </header>

    <div class="grid">
      <div class="card">
        <div class="card-title">Security Score</div>
        <div class="card-value" id="security-score">--</div>
        <div class="card-change"><span class="badge badge-success" id="security-grade">A</span></div>
      </div>
      <div class="card">
        <div class="card-title">Test Pass Rate</div>
        <div class="card-value" id="pass-rate">--</div>
        <div class="progress">
          <div class="progress-bar" id="pass-rate-bar" style="width: 0%"></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">High Risk Tests</div>
        <div class="card-value" id="high-risk">--</div>
        <div class="card-change"><span class="badge badge-warning">Needs Attention</span></div>
      </div>
      <div class="card">
        <div class="card-title">Speedup</div>
        <div class="card-value" id="speedup">--</div>
        <div class="card-change">Parallelization optimization</div>
      </div>
    </div>

    <div class="tab-nav">
      <div class="tab active" onclick="switchTab('overview')">Overview</div>
      <div class="tab" onclick="switchTab('prioritize')">AI Prioritization</div>
      <div class="tab" onclick="switchTab('predict')">Predictions</div>
      <div class="tab" onclick="switchTab('security')">Security</div>
      <div class="tab" onclick="switchTab('github')">GitHub</div>
      <div class="tab" onclick="switchTab('console')">Live Console</div>
    </div>

    <div id="overview" class="tab-content active">
      <div class="grid">
        <div class="card">
          <div class="card-title">Recent Test Runs</div>
          <ul class="list" id="recent-runs">
            <li class="list-item">No runs yet</li>
          </ul>
        </div>
        <div class="card">
          <div class="card-title">System Health</div>
          <div class="metric">
            <span>CPU Usage</span>
            <span id="cpu">--</span>
          </div>
          <div class="metric">
            <span>Memory</span>
            <span id="memory">--</span>
          </div>
          <div class="metric">
            <span>Uptime</span>
            <span id="uptime">--</span>
          </div>
        </div>
      </div>
    </div>

    <div id="prioritize" class="tab-content">
      <div class="card">
        <div class="card-title">AI Test Prioritization</div>
        <ul class="list" id="priorities-list"></ul>
      </div>
    </div>

    <div id="predict" class="tab-content">
      <div class="card">
        <div class="card-title">Failure Predictions</div>
        <ul class="list" id="predictions-list"></ul>
      </div>
    </div>

    <div id="security" class="tab-content">
      <div class="card">
        <div class="card-title">Security Vulnerabilities</div>
        <ul class="list" id="security-list"></ul>
      </div>
    </div>

    <div id="github" class="tab-content">
      <div class="grid">
        <div class="card">
          <div class="card-title">Repository Info</div>
          <div id="repo-info">Loading...</div>
          <div style="margin-top: 16px; display: flex; gap: 8px;">
            <button class="btn btn-primary" onclick="syncGitHub()">üîÑ Sync</button>
            <button class="btn btn-secondary" onclick="pullLatest()">‚¨áÔ∏è Pull</button>
          </div>
        </div>
        <div class="card">
          <div class="card-title">Recent Commits</div>
          <ul class="list" id="commits-list"></ul>
        </div>
      </div>
    </div>

    <div id="console" class="tab-content">
      <div class="card">
        <div class="card-title">Live Console</div>
        <div id="console-output"></div>
      </div>
    </div>
  </div>

  <script>
    const API = '';
    let eventSource = null;

    // SSE for real-time updates
    function connectSSE() {
      eventSource = new EventSource(`${API}/api/stream`);
      eventSource.onmessage = (e) => {
        const { event, data } = JSON.parse(e.data);
        handleEvent(event, data);
      };
    }

    function handleEvent(event, data) {
      const console = document.getElementById('console-output');
      const time = new Date().toLocaleTimeString();

      if (event === 'status') {
        console.innerHTML += `[${time}] ${data}\n`;
        setStatus(data, 'warning');
      } else if (event === 'complete') {
        console.innerHTML += `[${time}] ‚úÖ Complete\n`;
        setStatus('Complete', 'success');
        refreshAll();
      } else if (event === 'error') {
        console.innerHTML += `[${time}] ‚ùå Error: ${data}\n`;
        setStatus('Error', 'danger');
      }
      console.scrollTop = console.scrollHeight;
    }

    function setStatus(text, type = 'success') {
      const status = document.getElementById('status');
      const icon = type === 'success' ? 'üü¢' : type === 'warning' ? 'üü°' : 'üî¥';
      status.innerHTML = `${icon} ${text}`;
    }

    async function api(endpoint) {
      const res = await fetch(`${API}/api/${endpoint}`);
      return res.json();
    }

    async function runFull() {
      setStatus('Running...', 'warning');
      await api('run');
    }

    async function runQuick() {
      setStatus('Running quick check...', 'warning');
      await api('run/quick');
    }

    async function loadPriorities() {
      const data = await api('prioritize');
      const list = document.getElementById('priorities-list');
      list.innerHTML = data.priorities.map(p => `
        <li class="list-item">
          <div>
            <div><strong>${p.name.split('/').pop()}</strong></div>
            <div style="font-size: 12px; color: var(--muted);">
              Priority: ${p.priority.toFixed(0)} ‚Ä¢
              Failure Risk: ${(p.failureProbability * 100).toFixed(1)}%
            </div>
          </div>
          <span class="badge ${p.failureProbability > 0.5 ? 'badge-danger' : 'badge-success'}">
            ${p.failureProbability > 0.5 ? 'High Risk' : 'Low Risk'}
          </span>
        </li>
      `).join('');
      document.getElementById('high-risk').textContent = data.highRisk;
    }

    async function loadPredictions() {
      const data = await api('predict');
      const list = document.getElementById('predictions-list');
      list.innerHTML = data.predictions.slice(0, 10).map(p => `
        <li class="list-item">
          <div>
            <div><strong>${p.testName.split('/').pop()}</strong></div>
            <div style="font-size: 12px; color: var(--muted);">
              ${p.riskFactors.join(', ')}
            </div>
          </div>
          <div style="text-align: right;">
            <div style="font-weight: bold; color: ${p.failureProbability > 0.7 ? 'var(--danger)' : 'var(--success)'}">
              ${(p.failureProbability * 100).toFixed(0)}%
            </div>
            <div style="font-size: 10px; color: var(--muted);">${p.trend}</div>
          </div>
        </li>
      `).join('');
    }

    async function loadSecurity() {
      const data = await api('security');
      document.getElementById('security-score').textContent = data.score;
      document.getElementById('security-grade').textContent = data.grade;
      document.getElementById('security-grade').className =
        `badge ${data.grade === 'A' || data.grade === 'B' ? 'badge-success' :
                data.grade === 'C' ? 'badge-warning' : 'badge-danger'}`;

      const list = document.getElementById('security-list');
      const vulns = data.vulnerabilities.slice(0, 10);
      list.innerHTML = vulns.length ? vulns.map(v => `
        <li class="list-item">
          <div>
            <div><strong>${v.type}</strong></div>
            <div style="font-size: 12px; color: var(--muted);">${v.location}</div>
          </div>
          <span class="badge badge-${v.severity === 'critical' ? 'danger' : v.severity === 'high' ? 'warning' : 'success'}">
            ${v.severity}
          </span>
        </li>
      `).join('') : '<li class="list-item">‚úÖ No vulnerabilities detected</li>';
    }

    async function loadStatus() {
      const data = await api('status');
      document.getElementById('uptime').textContent = `${Math.floor(data.uptime / 60)}m`;
      setStatus('Running', 'success');
    }

    async function loadParallel() {
      const data = await api('parallel');
      document.getElementById('speedup').textContent = `${data.speedup.toFixed(1)}x`;
    }

    async function refreshAll() {
      await Promise.all([
        loadPriorities(),
        loadPredictions(),
        loadSecurity(),
        loadStatus(),
        loadParallel()
      ]);
    }

    async function syncGitHub() {
      const data = await api('github/sync');
      loadGitHub();
      setStatus('GitHub synced', 'success');
    }

    async function pullLatest() {
      const data = await api('github/pull');
      setStatus(data.message, data.success ? 'success' : 'danger');
    }

    async function loadGitHub() {
      const data = await api('github/repos');
      const info = document.getElementById('repo-info');
      if (data.repos && data.repos.length > 0) {
        const repo = data.repos[0];
        info.innerHTML = `
          <div class="metric">
            <span>Repository</span>
            <a href="${repo.url}" target="_blank" style="color: var(--primary);">
              ${repo.owner}/${repo.name}
            </a>
          </div>
          <div class="metric">
            <span>Branch</span>
            <span>${repo.branch}</span>
          </div>
          <div class="metric">
            <span>Tests</span>
            <span>${repo.testCount}</span>
          </div>
          <div class="metric">
            <span>Last Commit</span>
            <span>${repo.lastCommit}</span>
          </div>
        `;
      } else {
        info.innerHTML = '<div style="color: var(--muted);">No repository synced</div>';
      }

      const commits = await api('github/commits');
      const list = document.getElementById('commits-list');
      if (commits.commits && commits.commits.length > 0) {
        list.innerHTML = commits.commits.slice(0, 10).map(c => `
          <li class="list-item">
            <div>
              <div><strong>${c.message}</strong></div>
              <div style="font-size: 12px; color: var(--muted);">
                ${c.author} ‚Ä¢ ${c.date}
              </div>
            </div>
            <span style="font-family: monospace; font-size: 12px; color: var(--muted);">
              ${c.hash}
            </span>
          </li>
        `).join('');
      } else {
        list.innerHTML = '<li class="list-item">No commits</li>';
      }
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      const tabs = ['overview', 'prioritize', 'predict', 'security', 'github', 'console'];
      document.querySelector(`.tab:nth-child(${tabs.indexOf(tab) + 1})`).classList.add('active');
      document.getElementById(tab).classList.add('active');

      if (tab === 'github') loadGitHub();
    }

    // Initialize
    connectSSE();
    refreshAll();
    setInterval(loadStatus, 5000);
  </script>
</body>
</html>
